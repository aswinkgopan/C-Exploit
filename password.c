#include <crypt.h>
#include <ctype.h>
#include <stdlib.h>
#include <stdio.h>
#include <limits.h>
#include <string.h>
#include <stdlib.h>

#define bufSize 1024

struct entry_s {
    char *key;
    char *value;
    char status;
    struct entry_s *next;
};

typedef struct entry_s entry_t;

struct hashtable_s{
    int size;
    struct entry_s **table;
};

typedef struct hashtable_s hashtable_t;

hashtable_t *ht_create( int size ){
    hashtable_t *hashtable = NULL;
    int i=0;
    if ( size < 1 )
        return NULL;
    hashtable = malloc(sizeof(hashtable_t));
    if (hashtable == NULL)
        return NULL;
    hashtable->table = malloc(sizeof(entry_t*) * size);
    if (hashtable->table == NULL)
        return NULL;
    for(i = 0;i<size;i++)
        hashtable->table[i] = NULL;
    hashtable->size = size;
    return hashtable;
}

int ht_hash(hashtable_t *hashtable, char *key){
    unsigned long int hashval = 0;
    unsigned int i = 0;
    while(hashval < ULONG_MAX && i < strlen( key )){
        hashval = hashval << 8;
        hashval += key [ i ];
        i++;
    }
    return hashval % hashtable->size;
}

entry_t *ht_newpair(char *key, char *value ){
    entry_t *newpair;
    newpair = malloc(sizeof( entry_t )) ;
    if (newpair == NULL) return NULL;
    newpair->key = strdup( key );
    if (newpair->key == NULL) return NULL;
    newpair->value = strdup( value );
    if (newpair->value == NULL) return NULL;
    newpair->next = NULL;  
    newpair->status = 'F';
    return newpair; 
}

void ht_set(hashtable_t *hashtable,char *key, char *value){
    unsigned int bin = 0;
    entry_t *newpair = NULL;
    entry_t *next = NULL;
    entry_t *last = NULL;
    bin = ht_hash(hashtable,key); 
    next = hashtable->table[bin];
    
    /* 
     printf("\n--------------------------------------------------------------------------");
     printf("\nstarted at addresss of next :%p and inserting %s at bin %d ",next,value,bin);
     if (next != NULL) {
     printf(" %d----%s----%s----%d->\n",bin,next->value,next->key,strcmp(key,next->key));
     printf("The boolean value is %d ",next != NULL && next->key != NULL && strcmp(key,next->key));
     printf("\nTo be inserted %s ",key);
     printf("\nValue 1-> %d",next == NULL);
     printf("\nValue 2-> %d",next != NULL);
     printf("\nValue 3-> %d",next->key != NULL);
     printf("\nValue 4-> %d",strcmp(key,next->key));
     }
     */
    while( next != NULL && next->key != NULL && strcmp(key,next->key) != 0) {
        last=next;
        next = next->next;
    }
    if (next != NULL && next->key != NULL && strcmp( key,next->key) == 0){
        if (strcmp(next->value,value) == 0) {
            free(next->value);
            next->value = strdup( value );
        }else{
            while (next != NULL && next->key != NULL && strcmp(key,next->key) == 0) {
                last = next;
                next = next->next;
            }
            newpair = ht_newpair(key,value);
            if (next == hashtable->table[ bin ]){
                newpair->next = next;
                hashtable->table[ bin ] = newpair;
            }else if ( next == NULL ){
                last->next = newpair;
            }else{
                newpair->next= next;
                last->next = newpair;
            }
        }
    }else{
        newpair = ht_newpair(key,value);
        if (next == hashtable->table[ bin ]){
            newpair->next = next;
            hashtable->table[ bin ] = newpair;
        }else if ( next == NULL ){
            last->next = newpair;
        }else{
            newpair->next= next;
            last->next = newpair;
        }
    }
}

char *ht_get( hashtable_t *hashtable, char *key ) {
    unsigned int bin = 0;
    entry_t *pair;
    bin = ht_hash( hashtable, key );
    pair = hashtable->table[ bin ];
    while( pair != NULL && pair->key != NULL && strcmp( key, pair->key ) != 0) {
        pair = pair->next;
    }
    if( pair == NULL || pair->key == NULL || strcmp( key, pair->key ) != 0 ) {
        return "";
    }else{
        while (pair != NULL && pair->status == 'T' && strcmp(key,pair->key) == 0) {
            pair = pair -> next;
        }
        if( pair == NULL || pair->key == NULL || strcmp( key, pair->key ) != 0 )
            return "";
        else{
            pair->status = 'T';
            return pair->value;
        }
    }
}

char *makeLower(char *name){
  unsigned int i = 0;
  for(i=0;name[i];){
    name[i] = tolower(name[i]);
    i++;
  }
return name;
}

char *makeUpper(char *name){
  unsigned int i = 0;
  for(i=0;name[i];){
    name[i] = toupper(name[i]);
    i++;
  }
return name;
}

char *makeCapital(char *name){
  unsigned int i = 0;
  name[0] = toupper(name[0]);
  for (i=1 ; i < strlen(name); i++){
    name[i] = tolower(name[i]);
 }
return name;
}

char *makeHalfCap(char *name){
  unsigned int len = strlen(name);
  unsigned int i = 0;
  if (len%2 == 0 && len > 1){
    for(i = 0;i < len/2;i++){
      name[i] = toupper(name[i]);
    }
  }else if(len%2 != 0 && strlen(name) >= 3) {
    i = 0;
    name = makeUpper(name);
    for(i=0;i<strlen(name);i+=2){
      name[i] = tolower(name[i]);
    }
  }
return name;
}

char *makeEndsCapital(char *name){
  name = makeLower(name);
  name[0] = toupper(name[0]);
  name[strlen(name)-1] = toupper(name[strlen(name)-1]);
 return name;
}

char *makeLastCapital(char *name){
 name = makeLower(name);
 name[strlen(name)-1] = toupper(name[strlen(name)-1]);
return name;
}

void removeJunk(char *buf, char *userid){

  char *c = NULL,*p = NULL;
  FILE *writeName = NULL;
  char **new_list = NULL;
  unsigned int i=0;
  unsigned int j=0;
  unsigned int space_count=0;
  //unsigned int length = 0;
  //char *id = NULL;
  char temp[200],numstr[50];

  writeName = fopen("dict.txt","a");
  //result = (char*)malloc(strlen(buf)*sizeof(char));
  //id = (char*)malloc(sizeof(buf)*sizeof(char));
  for(i=0;i<strlen(buf);i++) if(buf[i] == ' ') space_count++;
  if ((c = strchr(buf,',')) != NULL) *c = '\0';
  new_list = malloc(((space_count+1)+1)*sizeof(char*));
  i = 0;
  p = strtok(buf," ");
  while(p){
    new_list[i] = malloc(sizeof(p)*sizeof(char));
    new_list[i] = p;
    i++;
    p = strtok(NULL," ");
  }
  
  for(j=0;j<space_count+1;j++){
    
    fprintf(writeName,"%s\n",new_list[j]);   //original
    fprintf(writeName,"%s\n",makeHalfCap(new_list[j])); //half caital AAbc
    fprintf(writeName,"%s\n",makeCapital(new_list[j])); //Abc
    fprintf(writeName,"%s\n",makeUpper(new_list[j]));   //ABC
    fprintf(writeName,"%s\n",makeLower(new_list[j]));   //abc
    fprintf(writeName,"%s\n",makeEndsCapital(new_list[j])); //AfsdfsdC
    fprintf(writeName,"%s\n",makeLastCapital(new_list[j])); //adasdas


    for(i = 1970;i < 2000;i++ ){   //add yearof birth to user
      new_list[j] = makeLower(new_list[j]);
      strncpy(temp,new_list[j],strlen(new_list[j]));
      sprintf(numstr,"%d",i);
      strcat(temp,numstr);    
      fprintf(writeName,"%s\n",temp);
    }

    memset(temp,0,strlen(temp));
    memset(numstr,0,strlen(temp));
    for(i = 70; i< 99 ;i++ ){     //add 2 digit year of birth to user
      strncpy(temp,new_list[j],strlen(new_list[j]));
      sprintf(numstr,"%d",i);
      strcat(temp,numstr);
      fprintf(writeName,"%s\n",temp);   
    }
    
    memset(temp,0,strlen(temp));  //writing xor to name
    memset(numstr,0,strlen(temp));

    strncpy(temp,makeLower(new_list[0]),strlen(new_list[0]));
    strcat(temp,"xor");
    fprintf(writeName,"%s\n",temp);

    memset(temp,0,strlen(temp));  //writing xor to name

    strncpy(temp,makeLower(new_list[0]),strlen(new_list[0]));
    strcat(temp,"zorz");
    fprintf(writeName,"%s\n",temp);
    
    memset(temp,0,strlen(temp));
    strcat(new_list[0],userid);

    strncpy(temp,new_list[0],strlen(new_list[0]));  //add userid to name
    if (temp != NULL) { 
         fprintf(writeName,"%s\n",temp);
         fprintf(writeName,"%s\n",makeUpper(temp));
         fprintf(writeName,"%s\n",makeLower(temp));
    }

    
  }
  fflush(writeName);
  fclose(writeName);
}

char *getSaltSubstring(char *my_string){
    int i=0,j = 5;
    char *newstring = malloc(sizeof(char)*7);
    newstring[6] = '\0';
    for (i=5; i >= 0; i--) {
        newstring[j--] += my_string[i];
    }
    return newstring;
}

int main(int argc, char *argv[]){
    char *c = NULL;
    char *userid = NULL;
    char buf[bufSize];
    FILE *fread_from_dictionary = NULL;
    FILE *fread_from_shadow_file = NULL;
    FILE *fread_from_passwd_file = NULL;
    char *line = NULL,*p = NULL;
    char *salt = NULL;
    char *username = NULL; 
    char *hashed_password= NULL;
    int i = 0;
    char *pass =  NULL;

    if (argc != 3){
        fprintf(stderr,"Error: Incorrect number of parameters");
        exit(-1);
    }
    fread_from_dictionary = fopen("dict.txt","r");
    if(fread_from_dictionary == NULL){
        fprintf(stderr,"Error: Unable to open the dictionary file");
        exit(-1);
    }
    fread_from_passwd_file = fopen(argv[1],"r");
    if(fread_from_passwd_file == NULL){
        fprintf(stderr,"Error: Unable to open the shadow file");
        fclose(fread_from_dictionary);
        exit(-1);
    }
    fread_from_shadow_file = fopen(argv[2],"r");
    if(fread_from_shadow_file == NULL){
       fprintf(stderr,"Error: Unable to open the passwd file");
       fclose(fread_from_passwd_file);
       fclose(fread_from_dictionary);
       fclose(fread_from_shadow_file);
       exit(-1);
    } 

    line = fgets(argv[2],100,fread_from_shadow_file);
    p = strtok(line,":");
    while(p != NULL){
        i++;
        if (i == 2){
            salt = getSaltSubstring(p);
        }
        p = strtok(NULL,":");
    }
    rewind(fread_from_shadow_file);

    //reading from the passwd file for names 
    userid = malloc(sizeof(buf)*sizeof(char)); 
 
    while(fgets(buf, sizeof(buf), fread_from_passwd_file) != NULL){
       i=0;
       p = strtok(buf,":");
       while(p != NULL){
         i++;
         if (i == 3) userid=p;
         if(i == 5) removeJunk(p,userid);
        p = strtok(NULL,":");
       } 
    } 
   // printf("Doing Stuffs.. Please wait..\n");
    //printf("dsfsdf");  


    hashtable_t *hashtable_passwrd = ht_create(1244);
     
   // printf("hello");
    while (fgets(buf, sizeof(buf), fread_from_shadow_file) != NULL){

        i = 0;
        p = strtok(buf,":");
        while(p != NULL){
            i++;
            if (i == 1){
                username = p;
            }
            if (i == 2){
                hashed_password = p;
            }
            p = strtok(NULL,":");
        }
        ht_set( hashtable_passwrd,  hashed_password , username);
    }
    memset(buf,0,strlen(buf));
    while (fgets(buf, sizeof(buf), fread_from_dictionary) != NULL){
        c = strchr(buf,'\n');
        if (c) *c = '\0';     
        line = crypt(buf,salt);
        if ((strcmp(pass = ht_get(hashtable_passwrd,line), "") != 0)){
               fprintf(stdout,"%s:%s\n",pass,buf);
               fflush(stdout);
        }
    }

    fflush(fread_from_shadow_file);
    fflush(fread_from_dictionary);
    fclose(fread_from_shadow_file);
    fclose(fread_from_dictionary);   
}
